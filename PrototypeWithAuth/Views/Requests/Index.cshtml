@model IPagedList<PrototypeWithAuth.Models.Request>
@using PrototypeWithAuth.AppData;

@using PrototypeWithAuth.Data;
@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager

@using X.PagedList.Mvc.Core; @* import this so we get our HTML Helper *@
@using X.PagedList; @* import this so we can cast our list to IPagedList (only necessary because ViewBag is dynamic)*@

<!-- import the included stylesheet for some (very basic) default styling -->
@*<link href="/Content/PagedList.css" rel="stylesheet" type="text/css" />*@


@{
    ViewData["Title"] = "Index";

    Layout = "~/Views/Shared/RequestNavView.cshtml";
    /*
     * BEGIN REMEMBERING DATA
     */
    var backTextBool = false;
    string backText = "";
    string backLink = "";
    string pgt = "";

    //paged list booleans
    AppUtility.RequestPageTypeEnum plPageType = AppUtility.RequestPageTypeEnum.Request;
    int plRequestStatusID = 1;
    int plSubcategoryID = 0;
    int plVendorID = 0;
    string plApplicationUserID = null;
    int plParentLocationInstanceID = 0;


    if (TempData["TempPageType"] != null)
    {
        pgt = TempData["TempPageType"].ToString();
        TempData["TempPageType"] = TempData["TempPageType"];
    }
    if (TempData["TempPage"] != null)
    {
        TempData["TempPage"] = TempData["TempPage"];
    }
    if (TempData["TempRequestStatusID"] != null)
    {
        TempData["TempRequestStatusID"] = TempData["TempRequestStatusID"];
    }
    if (TempData["TempSubcategoryID"] != null)
    {
        if ((Int32)TempData["TempSubcategoryID"] > 0)
        {
            backTextBool = true;
            backText = TempData["TempSubcategoryID"].ToString();
            backLink = Url.ActionLink("Index", "ProductSubcategories", new { @PageType = pgt }).ToString();
        }
        TempData["TempSubcategoryID"] = TempData["TempSubcategoryID"];
    }
    if (TempData["TempVendorID"] != null)
    {
        if ((Int32)TempData["TempVendorID"] > 0)
        {
            backTextBool = true;
            backText = TempData["TempVendorID"].ToString();
            backLink = Url.ActionLink("Index", "Vendors", new { @PageType = pgt }).ToString();
        }
        TempData["TempVendorID"] = TempData["TempVendorID"];
    }
    if (TempData["TempApplicationUserID"] != null)
    {
        if (!string.IsNullOrEmpty(TempData["TempApplicationUserID"].ToString()))
        {
            backTextBool = true;
            backText = TempData["TempApplicationUserID"].ToString();
            backLink = Url.ActionLink("Index", "ApplicationUsers", new { @PageType = pgt }).ToString();
        }
        TempData["TempApplicationUserID"] = TempData["TempApplicationUserID"];
    }
    if (TempData["ParentLocationInstanceID"] != null)
    {
        TempData["ParentLocationInstanceID"] = TempData["ParentLocationInstanceID"];
    }
    /*RequestsSearchViewModel?
    TempData["TempRequestsSearchViewModel"] = requestsSearchViewModel;*/
    /*
     * BEGIN REMEMBERING DATA
     * follow through on the modals these will be remembered on top
     */

    bool search = false;
    if (TempData["Search"] != null)
    {
        if (TempData["Search"].ToString() == "True")
        {
            search = true;
        }
    }

    int vendorID = 0; int subcategoryID = 0; string applicationUserID = null;
    if (TempData["VendorID"] != null)
    {
        vendorID = (int)TempData["VendorID"];
    }
    else if (TempData["SubcategoryID"] != null)
    {
        subcategoryID = (int)TempData["SubcategoryID"];
    }
    else if (TempData["ApplicationUserID"] != null)
    {
        applicationUserID = TempData["ApplicationUserID"].ToString();
    }

    var PageType = TempData[AppUtility.TempDataTypes.PageType.ToString()];

    //saving the info in a bool so I don't need to retest it against the enum anytime i want to see it in the page
    bool Request = false;
    bool Inventory = false;
    bool Summary = false;
    if (PageType.Equals(AppUtility.RequestPageTypeEnum.Request))
    {
        Request = true;
    }
    else if (PageType.Equals(AppUtility.RequestPageTypeEnum.Inventory))
    {
        Inventory = true;
    }
    else if (PageType.Equals(AppUtility.RequestPageTypeEnum.Summary))
    {
        Summary = true;
    }

    string newButtonText = "";
    string orderedButtonText = "";
    string receivedButtonText = "";
    string approvedButtonText = "";

    string newActiveClass = "";
    string orderedActiveClass = "";
    string receivedActiveClass = "";
    string approvedActiveClass = "";
    int requestStatusID = 0;
    bool isEquipment = PageType.Equals(AppUtility.LabManagementPageTypeEnum.Equipment);
    if (!search && !isEquipment)
    {
        newButtonText = "New [" + TempData["AmountNew"].ToString() + "]";
        orderedButtonText = "Ordered [" + TempData["AmountOrdered"].ToString() + "]";
        receivedButtonText = "Received [" + TempData["AmountReceived"].ToString() + "]";
        approvedButtonText = "Approved [" + TempData["AmountApproved"].ToString() + "]";

        //newActiveClass = "btn btn-outline-secondary text-dark new-button"; //used to be this...
        newActiveClass = "new-button pt-4 ";
        orderedActiveClass = "new-button pt-4 ";
        receivedActiveClass = "new-button pt-4 ";
        approvedActiveClass = "new-button pt-4 ";

        //changing the classes for the action links based on the tempdata of request status

        int.TryParse(TempData["RequestStatusID"].ToString(), out requestStatusID);
        switch (requestStatusID)
        {
            case 1:
            case 4:
            case 5:
                //newActiveClass = "btn btn-secondary text-dark new-button"; //used to be this...
                newActiveClass = "new-button active  pt-4";
                break;
            case 2:
                orderedActiveClass = "new-button active pt-4";
                break;
            case 3:
                receivedActiveClass = "new-button active  pt-4";
                break;
            case 6:
                approvedActiveClass = "new-button active  pt-4";
                break;

        }
    }


}

@*<h1>Index</h1>

    <p>
        <a asp-action="Create">Create New</a>
    </p>*@
@if (TempData["OpenConfirmEmailModal"] != null)
{
    <input type="text" id="tdconfirmemail" class="hidden" value="@TempData["RequestID"]" />
}
@if (TempData["ParentRequestConfirmEmail"] != null)
{
    <input type="text" id="tdprconfirmemail" class="hidden" value="@TempData["ParentRequestID"]" />
}
@if (TempData["OpenTermsModal"] != null)
{
    var termsType = TempData["OpenTermsModal"].ToString();
    switch (termsType)
    {
        case "Single":
            <input type="text" id="tdterms" class="hidden" value="@TempData["RequestID"]" />
            break;
    }
}

@if (backTextBool)
{
    <div class="row">
        <a href="@backLink">
            <i class="fas fa-long-arrow-alt-left"></i> @backText
        </a>
    </div>
}

@if (PageType.Equals(AppUtility.RequestPageTypeEnum.Request) && !search)
{
    <div class="">
        <div class="item-table">
            <ul class="pl-0">
                <li class="list-inline-item active m-0">
                    <a class="@newActiveClass" href="@Url.ActionLink("Index", "Requests", new { @applicationUserID = applicationUserID, @vendorID = vendorID, @subcategoryID = subcategoryID, @RequestStatusID = 1, @PageType = AppUtility.RequestPageTypeEnum.Request })"><i class="new-icon icon-centarix-icons-04"></i>  <label class="new-button-text">@newButtonText</label> </a>
                </li>
                <li class="list-inline-item m-0">
                    <a class="@approvedActiveClass" href="@Url.ActionLink("Index", "Requests", new { @applicationUserID = applicationUserID, @vendorID = vendorID, @subcategoryID = subcategoryID, @RequestStatusID = 6, @PageType = AppUtility.RequestPageTypeEnum.Request })"> <i class="new-icon icon-approve-24px"></i><label class="new-button-text">@approvedButtonText</label> </a>

                </li>

                <li class="list-inline-item m-0">
                    <a class="@orderedActiveClass" href="@Url.ActionLink("Index", "Requests", new { @applicationUserID = applicationUserID, @vendorID = vendorID, @subcategoryID = subcategoryID, @RequestStatusID = 2, @PageType = AppUtility.RequestPageTypeEnum.Request })"> <i class="new-icon icon-centarix-icons-03"></i><label class="new-button-text">@orderedButtonText</label> </a>
                </li>

                <li class="list-inline-item ">
                    <a class="@receivedActiveClass" href="@Url.ActionLink("Index", "Requests", new { @applicationUserID = applicationUserID, @vendorID = vendorID, @subcategoryID = subcategoryID, @RequestStatusID = 3, @PageType = AppUtility.RequestPageTypeEnum.Request })"> <i class="icon-done-24px new-icon"></i><label class="new-button-text">@receivedButtonText</label> </a>
                </li>
            </ul>
        </div>
    </div>
}

<div class="">
    <table class="table table-headerspaced table-noheaderlines table-hover ">
        <thead>
            <tr class="text-center">
                @*<th>@Html.DisplayNameFor(model => model[0].Product.ProductMedia)</th>*@
                <th></th>
                <th></th>
                @*<th>@Html.DisplayNameFor(model => model[0].Product.ProductName)</th>*@
                <th>Item Name</th>
                @*<th>@Html.DisplayNameFor(m => m[0].Product.Vendor.VendorEnName)</th>*@
                <th>Vendor</th>
                @if (!Summary)
                {
                    <th>Amount</th>
                }

                @*Placeholder until we insert total*@
                <th>@Html.DisplayNameFor(m => m[0].Cost)</th>
                @*Later on should have a better location...*@
                @if (Inventory)
                {
                    <th> Location </th>
                }
                <th>@Html.DisplayNameFor(m => m[0].Product.ProductSubcategory.ProductSubcategoryDescription)</th>
                @*<th>@Html.DisplayNameFor(m => m[0].ParentRequest.ApplicationUser.FirstName) @Html.DisplayNameFor(m => m[0].ParentRequest.ApplicationUser.LastName)</th>*@

                @if (!Summary)
                {
                    <th>Owner</th>
                    if (requestStatusID == 2)
                    {
                        <th>@Html.DisplayNameFor(m => m[0].ParentRequest.OrderDate)</th>
                    }
                    else if (requestStatusID == 3)
                    {
                        <th>@Html.DisplayNameFor(m => m[0].ArrivalDate)</th>
                    }
                    else
                    {
                        <th>Request Date</th>
                    }
                }
                else
                {
                    <th>Last Ordered</th>
                }
                <th></th>

            </tr>
        </thead>
        <tbody>
            @*@foreach (var item in Model)*@
            @for (int itemNum = 0; itemNum < Model.Count; itemNum++)
            {
                <tr class="text-center ">
                    <td>
                        <div class="form-check" >
                            <input type="checkbox" class="form-check-input fci-oi filled-in" id="@Model[itemNum].RequestID">
                            <label class="form-check-label" for="@Model[itemNum].RequestID">@Model[itemNum].RequestID</label>
                        </div>
                    </td>
                    <td>
                        @if (Model[itemNum].Product.ProductSubcategory.ImageURL != null)
                        {
                            var imageurl = Model[itemNum].Product.ProductSubcategory.ImageURL;
                            <img src="@imageurl" alt="Image" width="75" class="category-image" />
                        }
                        else
                        {
                            <img src="~/images/css/accounting/sample_image.png" alt="Image" width="75" class="category-image" />
                        }
                    </td>
                    @if (Summary)
                    {
                        <td width="15%">
                            <button class="btn p-0 m-0 inv-link-clr load-product-details-summary no-box-shadow" title="Details" value="@Model[itemNum].RequestID" data-target="item" href="item">
                                <p class="m-0">@Html.DisplayFor(modelItem => Model[itemNum].Product.ProductName)</p>
                            </button>
                        </td>
                    }
                    else
                    {
                        <td width="15%">
                            <button class="btn p-0 m-0 inv-link-clr load-product-details no-box-shadow" title="Details" value="@Model[itemNum].RequestID" data-target="item" href="item">
                                <p class="m-0">@Html.DisplayFor(modelItem => Model[itemNum].Product.ProductName)</p>
                            </button>
                        </td>
                    }


                    <td> @Html.DisplayFor(modelItem => Model[itemNum].Product.Vendor.VendorEnName) </td>
                    @if (!Summary)
                    {
                        <td>
                            <ul style="list-style: none; padding-left:0px;" class="mb-0">

                                @if (Model[itemNum].Unit != null)
                                {
                                    <li>
                                        @Html.DisplayFor(modelItem => Model[itemNum].Unit)
                                        @Html.DisplayFor(modelItem => Model[itemNum].UnitType.UnitTypeDescription)
                                    </li>
                                    @if (Model[itemNum].SubUnit != null)
                                    {
                                        <li>
                                            @Html.DisplayFor(modelItem => Model[itemNum].SubUnit)
                                            @Html.DisplayFor(modelItem => Model[itemNum].SubUnitType.UnitTypeDescription)
                                        </li>
                                        @if (Model[itemNum].SubSubUnit != null)
                                        {
                                            <li>
                                                @Html.DisplayFor(modelItem => Model[itemNum].SubSubUnit)
                                                @Html.DisplayFor(modelItem => Model[itemNum].SubSubUnitType.UnitTypeDescription)
                                            </li>
                                        }
                                    }

                                }


                            </ul>
                        </td>
                        @*Computed column?*@
                    }

                    <td>
                        @*@Html.DisplayFor(modelItem => item.Cost)*@
                        @{
                            decimal cost = (decimal)Model[itemNum].Cost;
                            string formattedCost = cost.ToString("C02");
                        }
                        @formattedCost
                    </td>
                    @*Later on should have a better location...*@
                    @if (Inventory)
                    {

                        <td>
                            @if (Model[itemNum].RequestLocationInstances != null)
                            {
                                @Html.DisplayFor(modelItem => Model[itemNum].RequestLocationInstances.FirstOrDefault().LocationInstance.LocationInstanceName)
                            }
                        </td>
                    }
                    <td> @Html.DisplayFor(modelItem => Model[itemNum].Product.ProductSubcategory.ProductSubcategoryDescription) </td>
                    @if (!Summary)
                    {
                        <td>
                            @Html.DisplayFor(modelItem => Model[itemNum].ApplicationUserCreator.FirstName)
                            @Html.DisplayFor(modelItem => Model[itemNum].ApplicationUserCreator.LastName)
                        </td>
                    }
                    @{
                        if (requestStatusID == 2 || Summary)
                        {
                            <td>@Model[itemNum].ParentRequest.OrderDate.ToString("yyyy-MM-dd")</td>
                        }
                        else if (requestStatusID == 3)
                        {
                            <td>@Model[itemNum].ArrivalDate.ToString("yyyy-MM-dd")</td>
                        }
                        else
                        {
                            <td>@Model[itemNum].CreationDate.ToString("yyyy-MM-dd")</td>
                        }
                    }
                    <td width="9%">
                        <div class="d-inline-flex">
                            <div class="table-icon-div">


                                @if (Model[itemNum].RequestStatusID == 1)
                                {
                                    //this is a nested if b/c if user can't approve then i still don't want it to go the the else
                                    if (SignInManager.IsSignedIn(User) & (User.IsInRole("Admin")))
                                    {
                                        if (Model[itemNum] is Reorder)
                                        {
                                            <a class="btn p-0 m-0 no-box-shadow" data-title="Approve" href="@Url.Action("ApproveReorder", new { id = Model[itemNum].RequestID })">
                                                <i style="font-size:2rem; color:#00CA72;" class="icon-centarix-icons-03 hover-bold"></i>
                                            </a>
                                        }
                                        else
                                        {
                                            @*@Html.ActionLink("Approve", "ConfirmEmailModal", new { id = item.RequestID, IsBeingApproved = true }, new { @class = "btn btn-link" });*@

                                            <a class="btn p-0 m-0 no-box-shadow" data-title="Approve" href="@Url.Action("Approve", new { id = Model[itemNum].RequestID })">
                                                <i style="font-size:2rem; color:#00CA72;" class="icon-centarix-icons-03 hover-bold"></i>
                                            </a>
                                        }


                                    }
                                }

                                else if (Model[itemNum].RequestStatusID == 2)
                                {
                                    <button class="btn p-0 m-0 load-receive-and-location no-box-shadow" data-title="receive" value="@Model[itemNum].RequestID"><i style="font-size:2rem; color:#00CA72;" class="icon-done-24px hover-bold"></i></button> // receive
                                }
                                else
                                {
                                    @*work on getting the correct syntax to create a new product with*@
                                    <button class="btn p-0 m-0 load-order-details no-box-shadow" data-title="order" value="@Model[itemNum].RequestID"><i style="font-size:2rem; color:#00CA72;" class="icon-add_circle_outline-24px1 hover-bold"></i></button>// order
                                }

                            </div>
                            @if (isEquipment)
                            {
                                <div class="table-icon-div">
                                    <a class="btn p-0 m-0 no-box-shadow" data-title="Create" href="@Url.Action("CreateCalibration","Calibrations", new { requestid = Model[itemNum].RequestID })">
                                        <i style="        font-size: 2rem;
        color: var(--lab-man-color);" class="icon-settings-24px-1"></i>
                                    </a>
                                </div>
                            }
                            <div class="table-icon-div">
                                <button class="btn p-0 m-0 load-confirm-delete no-box-shadow" data-title="delete" value="@Model[itemNum].RequestID" name="@AppUtility.MenuItems.OrdersAndInventory"><i style="font-size:2rem;" class="icon-delete-24px hover-bold"></i></button>
                            </div>
                        </div>


                        @*@Html.ActionLink("Delete", "DeleteModal", new { id = item.RequestID}, new { @class = "btn btn-link" })*@
                        @*<button class="btn btn-link" asp-action="Delete" value="@item.RequestID" data-target="item" href="item"> Delete </button>*@
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div class="row">
    <div class="col-6 offset-6 text-center">
        @Html.PagedListPager(Model, page => Url.Action("Index", new { page = page, RequestStatusID = requestStatusID, }))
    </div>
</div>