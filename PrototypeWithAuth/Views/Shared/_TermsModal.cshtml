@model PrototypeWithAuth.ViewModels.TermsViewModel;
@using PrototypeWithAuth.AppData
@{
    Layout = null;

    var bcColor = "order-inv-background-color";
    string form = "";
    if (Model.RequestIndexObject.SectionType == AppUtility.MenuItems.Operations)
    {
        form = "oper-form";
        bcColor = "oper-background-color";
    }
    else if (Model.RequestIndexObject.SectionType == AppUtility.MenuItems.LabManagement)
    {
        bcColor = "lab-man-background-color";
        form = "supplier-form";
    }
    else if (Model.RequestIndexObject.SectionType == AppUtility.MenuItems.Requests)
    {
        //bcColor = "order-inv-background-color";
        //form = "order-inv-form"; //switched to outer terms modal
    }
}

<script src="~/js/TermsModal.js"></script>
<script src="~/js/site.js"></script>
<script src="~/js/Validation/TermsModalFormValidation.js"></script>
<script src="~/js/validate.js"></script>
<script src="~/js/InitializeDatePicker.js"></script>
@Html.HiddenFor(model => model.RequestIndexObject.PageType)
@Html.HiddenFor(model => model.RequestIndexObject.PageNumber)
@Html.HiddenFor(model => model.RequestIndexObject.SectionType)
@Html.HiddenFor(model => model.RequestIndexObject.SelectedCurrency)
@*@Html.HiddenFor(model => model.RequestIndexObject.SelectedPriceSort)*@
@Html.HiddenFor(model => model.RequestIndexObject.RequestStatusID)
@Html.HiddenFor(model => model.RequestIndexObject.SidebarFilterID)
@Html.HiddenFor(model => model.RequestIndexObject.SidebarType)
<input type="hidden" asp-for="ParentRequest.ParentRequestID" />
<div class="modal-header modal-header-padding">
    <div class="col-10 float-left">
        <span class="heading-1">Terms</span>
    </div>
</div>
<div class="modal-body">
    <div class="container">
        <div class="row text-danger-centarix"> @Model.ErrorMessage </div>
        <div class="row">

            <div class="col-3">
                <label class="control-label">Terms</label>
                @Html.DropDownListFor(m => m.SelectedTerm,
                    Model.TermsList,
                    new { @class = "mdb-select custom select-dropdown form-control-plaintext Terms", @id = "Terms", @searchable = "default value" }
                )

            </div>

            <div class="col-3">
                @{
                    var currency = Model.RequestIndexObject.SelectedCurrency == AppUtility.CurrencyEnum.NIS ? "&#x20aa;" : "&#36;";
                }
                <label asp-for="ParentRequest.Shipping" class="control-label"></label>
                <div class="input-group">
                    <span class="input-group-text pr-2">@Html.Raw(currency)</span>
                    <input asp-for="ParentRequest.Shipping" class="form-control-plaintext border-bottom" />
                    <span asp-validation-for="ParentRequest.Shipping" class="text-danger-centarix"></span>
                </div>
            </div>
            @{var dNone = "d-none";
                @*var disabled = true;*@}
            @*@if (Model.SelectedTerm == 5)
                {
                    dNone = "";
                    disabled = false;
                }*@
            <div class="col-3 @dNone installments-amount-block">
                <label asp-for="Installments" class="control-label"></label>
                <input asp-for="Installments" disabled class="form-control-plaintext border-bottom" />
                <span asp-validation-for="Installments" class="text-danger-centarix"></span>
            </div>
            <div class="col-3 @dNone installments-amount-block">
                <div class="form-group ">
                    <label asp-for="@Model.InstallmentDate" class="control-label m-0 mt-2" style="width:100%;"></label>
                    <input asp-for="@Model.InstallmentDate" type="text" class="form-control-plaintext border-bottom align-with-select m-0 p-0 datepicker" disabled asp-format="{0:dd/MM/yyyy}" data-val="@Model.InstallmentDate.ToString("yyyy-MM-dd")" />
                    <span asp-validation-for="@Model.InstallmentDate" class="text-danger-centarix"></span>
                </div>
            </div>

        </div>
    </div>
</div>
<input type="hidden" asp-for="ParentRequest.OrderDate" />
<input type="hidden" asp-for="ParentRequest.OrderNumber" />
<input type="hidden" asp-for="ParentRequest.ApplicationUserID" />
<input type="hidden" asp-for="RedirectAction" />
<script>
    $(".terms .mdb-select").materialSelect()</script>

<script>
    $(".submitTerms").off('click').on("click", function (e) {
        e.preventDefault();
        console.log("submit reorder");
        //alert("validate form");
        $(".termsModalForm").data("validator").settings.ignore = "";
        var valid = $(".termsModalForm").valid();
        console.log("valid form: " + valid)
        if (!valid) {

            if (!$('.activeSubmit').hasClass('disabled-submit')) {
                $('.activeSubmit').addClass('disabled-submit')
            }

        }
        else {
            $('.activeSubmit').removeClass('disabled-submit')
            $("#loading").show();
            $("#RedirectAction").val(window.location.href);
            alert("window: " + window.location.href);
            var formData = new FormData($(".termsModalForm")[0]);
            $.ajax({
                contentType: false,
                processData: false,
                async: true,
                url: "/Requests/TermsModal",
                data: formData,
                traditional: true,
                type: "POST",
                cache: false,
                success: function (data) {
                    if ($("#SectionType").val() == "Operations" && data == '') {
                        console.log("if 1");
                        window.location.href = "/Requests/Index?PageType=OperationsRequest&SectionType=Operations&RequestStatusID=2&SidebarType=List";
                    }
                    else if ($("#SectionType").val() == "Requests" && data == '') {
                        console.log("if 1");
                        window.location.href = "/Requests/Index?PageType=RequestRequest&SectionType=Requests&RequestStatusID=6&SidebarType=List";
                    }
                    else if ($("#RequestIndexObject_OrderType").val() == "AlreadyPurchased" && data == '') {
                        console.log("if 2");
                        window.location.href = "/Requests?PageType=RequestRequest&SectionType=Requests&SidebarType=List";
                    }
                    else {
                        $.fn.OpenModal('emailModal', 'confirm-email', data);
                    }
                    $("#loading").hide();
                    return true;
                },
                error: function (jqxhr) {
                    if (jqxhr.status == 500) {
                        $.fn.OpenModal('termsModal', 'terms', jqxhr.responseText);
                    }

                    $("#loading").hide();
                    return true;
                }
            });
        }
        $(".termsModalForm").data("validator").settings.ignore = ':not(select:hidden, input:visible, textarea:visible)';

        //return false;
    });</script>